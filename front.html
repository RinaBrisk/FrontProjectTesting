<!doctype html>
<head>
    <title>Проверка качества студенческих проектов</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="css/srs-styles.css">
    </head>
<body>

<header>
    <h1>Проверка качества студенческих проектов</h1>
</header>

<section>
	
	<form action="rina.html" method="post" accept-charset="UTF-8">
		
		<h2>Выберете действие:</h2>
		
		<div class="checkbox">
			<input type="checkbox" name="method" id="method_0" onchange="onMethodChange()" checked>
				<label for="method_0">Запустить тесты</label>
		</div>
				
		<div class="checkbox">
			<input type="checkbox" name="method" id="method_1">
				<label for="method_1">Проверить качество кода</label>
		</div>
		
		<div class="checkbox">
			<input type="checkbox" name="method" id="method_2">
				<label for="method_2">Подсчитать тестовое покрытие</label>
		</div>
	
		<h2>Введите данные:</h2>
		
		<div id="div_url">
			<h3>URL репозитория:</h3>
			<input type="text" name="url" id="url">
		</div>
	
		<div id="div_file">
			<h3>Файл с тестами:</h3>
			<input type="file" name="file" id="file">
		</div>
		
		<!-- <button type="submit" style="width:100%">Сохранить</button> -->
	</form>
	
	<button style="width:100%;" onClick="onRunButton()">Выполнить</button>
	
	<div id="div_result_0" hidden>
		<h2>Результат тестового прогона:</h2>
		<textarea id="result_0" readonly></textarea>
	</div>
	
	<div id="div_result_1" hidden>
		<h2>Результат проверки качества кода:</h2>
		<textarea id="result_1" readonly></textarea>
	</div>
	
	<a id="result_ref_1" href="https://example.com" target="_blank" hidden>Ссылка на отчет</a>
	
	<div id="div_result_2" hidden>
		<h2>Результат подсчета тестового покрытия:</h2>
		<textarea id="result_2" readonly></textarea>
	</div>
	
	<a id="result_ref_2" href="https://example.com" target="_blank" hidden>Ссылка на отчет</a>
	
</section>

</body>

<script>

onload = function(){
}

function onMethodChange(){
	var id_method_0 = document.getElementById('method_0');
	var div_file = document.getElementById("div_file");

	div_file.hidden = !id_method_0.checked;
}

function onRunButton(){
	var method_0 = document.getElementById("method_0");
	var method_1 = document.getElementById("method_1");
	var method_2 = document.getElementById("method_2");
	
	if(method_0.checked)
	{
		runTests();
	}
	
	if(method_1.checked)
	{
		codeQuality();
	}
	
	if(method_2.checked)
	{
		testCoverage();
	}
}

//async function getCourses(){
	//const service_url = "http://mmosevjy.beget.tech/?redirect=0";
	//const proxyurl = "https://cors-anywhere.herokuapp.com/";
	
	//var response = await fetch(proxyurl + service_url);

	//if (response.ok) { 

		//var htmlDoc = document.implementation.createHTMLDocument(htmlEncode(response.text));
		//var element = htmlDoc.getElementsByClassName('courses frontpage-course-list-all');
		//alert(element.innerHTML);
	//}
//}

//function htmlEncode(value){
 // return $('<textarea/>').text(value).html();
//}

async function runTests(){

	const url_text = document.getElementById("url").value;
	const file = document.getElementById("file").files[0];
	const service_url = "http://localhost:8082/projects/runTests";
	const result_field = document.getElementById("result_0");
	var div_result = document.getElementById('div_result_0');

	var formData = new FormData();
	formData.append("url", url_text);
	
	if(file != null){
		formData.append("file", file);
	}
	var response = await fetch(service_url, {
		method: "POST",
		body: formData
	});
	
	div_result.hidden = 0;

	if (response.ok) { 
		let result = await response.json();
		
		if(result.buildResult == "BUILD SUCCESS"){
			result_field.value += "Успешная сборка проекта\r\n \r\n";
		}else{
			result_field.value += "Неуспешная сборка проекта\r\n \r\n";
		}
		
		result_field.value += " Успешных кейсов: " + result.result.passCount + "\r\n";
		if(result.result.passCount > 0){
			var case_array = getAllCases(result);
			case_array.forEach(function(item, i, case_array) {
				if(result["cases"][i]["state"] == "PASSED"){
					result_field.value += "  * " + result["cases"][i]["name"] + "\r\n";
				}
			});
		}
		
		result_field.value += " Неуспешных кейсов: " + result.result.failCount + "\r\n";
		if(result.result.failCount > 0){
			var case_array = getAllCases(result);
			case_array.forEach(function(item, i, case_array) {
				if(result["cases"][i]["state"] == "FAILED"){
					result_field.value += "  * " + result["cases"][i]["name"];
				}
			});
		}
		
		result_field.value += " Пропущенных  кейсов: " + result.result.skipCount + "\r\n";
		if(result.result.skipCount > 0){
			var case_array = getAllCases(result);
			case_array.forEach(function(item, i, case_array) {
				if(result["cases"][i]["state"] == "SKIPPED"){
					result_field.value += "  * " + result["cases"][i]["name"];
				}
			});
		}
	}
}

function getAllCases(result){
	var i = 0;
	var case_array = [];
	while (result["cases"][i] != null) { 
		case_array.push(result["cases"][i]["name"]);
		i++;
	}
	return case_array;
}

async function codeQuality(){

	const url_text = document.getElementById("url").value;
	const service_url = "http://localhost:8082/projects/quality";
	const result_field = document.getElementById("result_1");
	var div_result = document.getElementById("div_result_1");
	var report_ref = document.getElementById("result_ref_1");

	var formData = new FormData();
	formData.append("url", url_text);
	
	var response = await fetch(service_url, {
		method: "POST",
		body: formData
	});
	
	div_result.hidden = 0;

	if (response.ok) { 
		report_ref.hidden = 0;
		let result = await response.json();
		
		if(result.buildResult == "BUILD SUCCESS"){
			result_field.value += "Успешная сборка проекта\r\n \r\n";
		}else{
			result_field.value += "Неуспешная сборка проекта\r\n \r\n";
		}
		
		result_field.value += " Обнаруженные предупреждения:\r\n \r\n";
		
		result_field.value += "  Высокой важности: " + result.numberOfHighPriorityWarnings + "\r\n";
		result_field.value += "  Средней важности: " + result.numberOfNormalPriorityWarnings + "\r\n";
		result_field.value += "  Низкой важности: " + result.numberOfLowPriorityWarnings + "\r\n";
		
		report_ref.href = result.report;
	}
}

async function testCoverage(){

	const url_text = document.getElementById("url").value;
	const service_url = "http://localhost:8082/projects/coverage";
	const result_field = document.getElementById("result_2");
	var div_result = document.getElementById('div_result_2');
	var report_ref = document.getElementById("result_ref_2");

	var formData = new FormData();
	formData.append("url", url_text);
	
	var response = await fetch(service_url, {
		method: "POST",
		body: formData
	});
	
	div_result.hidden = 0;	

	if (response.ok) { 
		report_ref.hidden = 0;
		let result = await response.json();
		
		if(result.buildResult == "BUILD SUCCESS"){
			result_field.value += "Успешная сборка проекта\r\n \r\n";
		}else{
			result_field.value += "Неуспешная сборка проекта\r\n \r\n";
		}
		
		result_field.value += "  Объем тестового покрытия\r\n \r\n";
		var methods_array = getAllMethods(result);
		methods_array.forEach(function(item, i, methods_array) {
			result_field.value += "  * " + item + ": " + result.coverage[item] + "\r\n";
		});
		report_ref.href = result.report;
	}
}

function getAllMethods(result){
	var methods_array = [];
	for (key in result.coverage) {
		if (result.coverage.hasOwnProperty(key)) {
			methods_array.push(key);
		}
	}
	return methods_array;
}

</script>

</html>